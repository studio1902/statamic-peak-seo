{{#
    @name Conmsent banner
    @desc The consent banner component defined in `statamic-peak-seo::snippets/_seo.antlers.html` and yielded in `resources/views/layout.antlers.html`.
#}}

{{ consent_types = [[
    'value' => true,
    'handle' => 'functionalCookies',
    'title' => '{ trans:strings.consent_functional }',
    'explanation' => '{ trans:strings.consent_functional_explanation }'
    'disabled' => true,
]] }}

{{ if seo:tracker_type == 'gtag' || seo:tracker_type == 'gtm' }}
    {{ consent_types += [
        'value' => false,
        'handle' => 'analyticsStorage',
        'title' => '{ trans:strings.consent_analytics }',
        'explanation' => '{ trans:strings.consent_analytics_explanation }',
        'consentAPI' => true
    ] }}
{{ /if }}

{{ if seo:tracker_type == 'gtm' }}
    {{ consent_types += [
        'value' => false,
        'handle' => 'adStorage',
        'title' => '{ trans:strings.consent_ads }',
        'explanation' => '{ trans:strings.consent_ads_explanation }',
        'consentAPI' => true
    ] }}
    {{ consent_types += [
        'value' => false,
        'handle' => 'adUserData',
        'title' => '{ trans:strings.consent_ad_user_data }',
        'explanation' => '{ trans:strings.consent_ad_user_data_explanation }',
        'consentAPI' => true ]
    }}
    {{ consent_types += [
        'value' => false,
        'handle' => 'adPersonalization',
        'title' => '{ trans:strings.consent_ad_personalization }',
        'explanation' => '{ trans:strings.consent_ad_personalization_explanation }',
        'consentAPI' => true
    ] }}
{{ /if }}

{{ if seo:tracker_type == 'scripts' }}
    {{ seo:scripts }}
        {{ consent_types += [
            'value' => false,
            'handle' => 'customScript' + {count},
            'title' => '{ category | add_slashes | entities }',
            'explanation' => '{ explainer | add_slashes | entities }'
            'custom' => true
        ] }}
    {{ /seo:scripts }}
{{ /if }}

{{ if seo:embeds }}
    {{ consent_types += [
        'value' => false,
        'handle' => 'embeds',
        'title' => '{ trans:strings.consent_embeds }',
        'explanation' => '{ trans:strings.consent_embeds_explanation }'
        'embeds' => true
    ] }}
{{ /if }}

<!-- statamic-peak-seo::components/_consent_banner.antlers.html -->
<div
    x-data="consentBanner"
    x-show="$store.consentBanner.consent === null"
    x-transition
    class="
        fixed z-50 inset-x-[1rem] bottom-[1rem] md:bottom-[2rem] md:w-80 flex flex-col p-6 space-y-4 bg-white border border-neutral/10 rounded shadow-lg
        {{ seo:display_style == 'left' ?= 'md:right-auto md:left-[2rem]' }}
        {{ seo:display_style == 'right' ?= 'md:left-auto md:right-[2rem]' }}
    "
    x-cloak
>
    <h2 class="text-2xl font-bold">{{ trans:strings.consent_title }}</h2>
    <p class="text-sm font-bold text-neutral">
        {{ trans:strings.consent_explanation }}
        {{ if configuration:cookie_notice_type == 'entry' }}
            <a class="px-1 -m-1 underline rounded hover:text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-primary" href="{{ configuration:consent_notice_entry:url }}">{{ trans:strings.consent_learn_more }}</a>
        {{ elseif configuration:cookie_notice_type == 'pdf' }}
            <a class="px-1 -m-1 underline rounded hover:text-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-primary" href="{{ configuration:consent_notice_asset }}" target="_blank">{{ trans:strings.consent_learn_more }}</a>
        {{ /if }}
    </p>

    <div class="mt-4 flex flex-col space-y-2">
        <template x-for="consentType in $store.consentBanner.consentTypes">
            <label class="inline-flex">
                <input class="mr-2 w-4 h-4 rounded border-neutral text-primary focus:outline-none focus-visible:ring focus-visible:ring-primary motion-safe:transition" type="checkbox" :name="consentType.handle" x-model="consentType.value">
                {{# opacity-50 :checked="consentType.disabled" :disabled="consentType.disabled" #}}
                <span class="flex flex-col">
                    <span class="font-bold text-xs" x-text="consentType.title"></span>
                    <span class="text-xs text-neutral/75" x-text="consentType.explanation"></span>
                </span>
            </label>
        </template>

        {{# x-model thirdParty checkbox only when scripts is being used. #}}
        {{ if seo:tracker_type == 'scripts' }}
            {{ seo:scripts }}
                {{# <label class="inline-flex">
                    <input class="mr-2 w-4 h-4 rounded border-neutral text-primary focus:outline-none focus-visible:ring focus-visible:ring-primary motion-safe:transition" type="checkbox" name="customScript{{ count }}" x-model="customScript{{ count }}">
                    <span class="flex flex-col">
                        <span class="font-bold text-xs">{{ category }}</span>
                        <span class="text-xs text-neutral/75">{{ explainer }}</span>
                    </span>
                </label> #}}

                {{# Render this stack in all your layouts after opening the <body>. #}}
                {{ script_fragments }}
                    {{ if type == 'body_content' }}
                        {{ push:seo_body }}
                            {{ body_content }}
                        {{ /push:seo_body }}
                    {{ /if }}
                {{ /script_fragments }}
            {{ /seo:scripts }}
        {{ /if }}
    </div>

    <div class="flex space-x-4">
        {{# Save all options. #}}
        <button
            @click="
                consentDate = '{{ now format="Y-m-d" }}'
                {{ if seo:tracker_type == 'gtag' || seo:tracker_type == 'gtm' }}
                    , analyticsStorage = true
                {{ /if }}
                {{ if seo:tracker_type == 'gtm' }}
                    , adStorage = true
                {{ /if }}
                {{ if seo:tracker_type == 'gtm' }}
                    , adUserData = true
                {{ /if }}
                {{ if seo:tracker_type == 'gtm' }}
                    , adPersonalization = true
                {{ /if }}
                {{ if seo:tracker_type == 'scripts' }}
                    {{ seo:scripts }}
                        , customScript{{ count }} = true
                    {{ /seo:scripts }}
                {{ /if }}
                {{ if seo:embeds }}
                    , embeds = true
                {{ /if }}
                , $store.consentBanner.setConsent(true)
            "
            type="button"
            class="px-4 py-2 bg-primary rounded text-sm font-bold text-white focus:outline-none focus-visible:ring focus-visible:ring-offset-2 focus-visible:ring-primary motion-safe:transition"
            >
            {{ trans:strings.consent_accept_all }}
        </button>

        {{# Save selected options. #}}
        <button
            @click="
                $store.consentBanner.setConsent(true),
                consentDate = '{{ now format="Y-m-d" }}'
            "
            type="button"
            class="px-1 py-2 rounded text-sm font-bold text-neutral focus:outline-none focus-visible:ring focus-visible:ring-offset-2 focus-visible:ring-primary motion-safe:transition"
        >
            {{ trans:strings.consent_accept_selected }}
        </button>
    </div>

    {{# Yield this section in `resources/layouts/_footer.antlers.html` so users can reset their consent. #}}
    {{ section:reset_consent }}
        <!-- statamic-peak-seo::components/_consent_Banner.antlers.html -->
        {{ if seo:use_consent_banner }}
            {{# Read out global store consent status and display a reset consent link by saving the initial state. #}}
            <span x-data x-cloak>
                <span x-show="$store.consentBanner.consent !== null">
                    <a @click.prevent="$store.consentBanner.setConsent(null)" class="{{ reset_consent_class ?? 'px-1 -mx-1 underline rounded hover:text-primary focus:outline-none focus-visible:ring-2 ring-primary motion-safe:transition-colors' }}" href="#">{{ trans:strings.consent_change_preferences }}</a>
                </span>
            </span>
        {{ /if }}
        <!-- End: statamic-peak-seo::components/_consent_Banner.antlers.html -->
    {{ /section:reset_consent }}

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('consentBanner', {
                consent: Alpine.$persist({{ seo:hide_by_default ? true : 'null' }}).as('consentBannerConsent'),
                consentDate: Alpine.$persist(null).as('consentBannerDate'),
                consentTypes: Alpine.$persist({{ consent_types | to_json }}).as('consentBanner'),
                setConsent(value) {
                    this.consent = value
                },
                setEmbeds(value) {
                    this.embeds = value
                }
            })

            Alpine.data('consentBanner', () => {
                return {
                    consentDate: Alpine.$persist(null).as('consentBannerDate'),
                    init() {
                        this.consentDate < '{{ seo:consent_revoke_before format="Y-m-d" }}'
                            ? (Alpine.store('consentBanner').setConsent(null), this.consentDate = null)
                            : ''
                    }
                }
            })
        })
    </script>
</div>
<!-- End: statamic-peak-seo::components/_consent_banner.antlers.html -->

{{# analyticsStorage: Alpine.$persist(false).as('consentBannerAnalyticsStorage'),
adStorage: Alpine.$persist(false).as('consentBannerAdStorage'),
adUserData: Alpine.$persist(false).as('consentBanneradUserData'),
adPersonalization: Alpine.$persist(false).as('consentBannerAdPersonalization'),
embeds: Alpine.store('consentBanner').embeds,
{{ seo:scripts }}
    customScript{{ count }}: Alpine.$persist(false).as('consentBannerCustomScript{{ count }}'),
{{ /seo:scripts }} #}}

{{#
x-effect="
    {{ if seo:tracker_type == 'gtag' || seo:tracker_type == 'gtm'}}
        $store.consentBanner.consent
            ? gtag('consent', 'update', {
                'analytics_storage': (analyticsStorage ? 'granted' : 'denied'),
                'ad_storage': (adStorage ? 'granted' : 'denied'),
                'ad_user_data': (adUserData ? 'granted' : 'denied'),
                'ad_personalization': (adPersonalization ? 'granted' : 'denied') })
            : ''
    {{ elseif seo:tracker_type == 'scripts' }}
        {{ seo:scripts }}
            if ($store.consentBanner.consent && customScript{{ count }}) {
                {{ script_fragments }}
                    var script{{ index }} = document.createElement('script')
                    {{ if type == 'script_tag' }}
                        script{{ index }}.src = '{{ source }}'
                    {{ else }}
                        script{{ index }}.text = '{{ inline_script | add_slashes | entities | collapse_whitespace }}'
                    {{ /if }}
                    {{ if type != 'body_content' }}
                        {{ defer ?= 'script{{ index }}.defer = true' }}
                        {{ async ?= 'script{{ index }}.async = true' }}
                        {{ _index = index }}
                        {{ inline_script_attributes }}
                            script{{ _index }}.setAttribute(
                                '{{ attribute | slugify }}',
                                '{{ attribute_value ? { attribute_value | entities } : 'true' }}'
                            )
                        {{ /inline_script_attributes }}
                    {{ /if }}
                    document.head.appendChild(script{{ index }})
                {{ /script_fragments }}
            }
        {{ /seo:scripts }}
    {{ /if }}

    $store.consentBanner.setEmbeds(embeds)
    $dispatch('embeds')
" #}}
